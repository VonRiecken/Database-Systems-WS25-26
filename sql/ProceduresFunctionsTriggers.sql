-- Function	CREATE DEFINER=`dbsysgr1`@`%` FUNCTION `fn_get_dynamic_price`(p_meal_price DECIMAL(10,2), p_user_role VARCHAR(20)) RETURNS decimal(10,2)		DETERMINISTIC	BEGIN		DECLARE final_price DECIMAL(10,2);		IF p_user_role = 'Admin' or p_user_role = 'Employee' THEN			-- Admins pay 10% more			SET final_price = p_meal_price * 1.10;		ELSE			-- Students pay normal price			SET final_price = p_meal_price;		END IF;		RETURN final_price;	END-- Procedures	CREATE DEFINER=`dbsysgr1`@`%` PROCEDURE `sp_get_monthly_sales`()	BEGIN		SELECT 			DATE(order_date) as report_date, 			COUNT(order_id) as total_orders, 			SUM(total_amount) as total_revenue		FROM `Order`		WHERE order_date >= DATE_SUB(NOW(), INTERVAL 1 MONTH)		GROUP BY DATE(order_date)		ORDER BY report_date DESC;	END	CREATE DEFINER=`dbsysgr1`@`%` PROCEDURE `sp_get_weekly_sales`()	BEGIN		SELECT 			DATE(order_date) as report_date, 			COUNT(order_id) as total_orders, 			SUM(total_amount) as total_revenue		FROM `Order`		WHERE order_date >= DATE_SUB(NOW(), INTERVAL 7 DAY)		GROUP BY DATE(order_date)		ORDER BY report_date DESC;	END		CREATE DEFINER=`dbsysgr1`@`%` PROCEDURE `sp_place_order`(					in p_meal_id INT,					in p_user_id INT,					in p_quantity INT,					in p_pickup_time TIME			)		BEGIN			declare v_role varchar(20);			declare v_meal_price decimal(5, 2);			declare v_is_available boolean;			declare v_total_amount decimal(6,2);			declare v_new_order_id int;			-- 1. if check quantity is valid				if p_quantity <= 0 then					SIGNAL SQLSTATE '45000'					SET MESSAGE_TEXT = 'Quantity must be greater than 0';				end if;			-- 2. Fetch meal details				-- to detect if no meal was found 				set v_meal_price = NULL; 							select price, is_available into v_meal_price, v_is_available				from Meal where meal_id = p_meal_id;					 -- Validation if meal must exist					if v_meal_price is NULL THEN 						SIGNAL SQLSTATE '45000'						SET MESSAGE_TEXT = 'MEAL ID does not exist';					end if;					if v_is_available is false then						signal sqlstate '45000'						set message_text = 'MEAL is currently sold out';					end if;			-- 3. Fetch user role				set v_role = NULL;				select role into v_role from User where user_id = p_user_id;					-- Validation if role is not exists					if v_role is NULL THEN 						SIGNAL SQLSTATE '45000'						SET MESSAGE_TEXT = 'User ID does not exists';					end if;			-- 4. Calculate total amount				SET v_total_amount = v_meal_price * p_quantity;					-- apply 10% surcharge for employees					if v_role = 'Employee' THEN						set v_total_amount = v_total_amount * 1.10;					end if;			-- 5. Insert into Order Header				-- MySQL does NOT support "RETURNING". We insert, then grab the ID.				INSERT INTO `Order` (user_id, pickup_time, status, total_amount, order_date)				VALUES (p_user_id, p_pickup_time, 'Pending', v_total_amount, NOW());								-- Capture the ID immediately				SET v_new_order_id = LAST_INSERT_ID();			-- 6. Insert into Order Item				INSERT INTO Order_Item (order_id, meal_id, quantity)				VALUES (v_new_order_id, p_meal_id, p_quantity);						-- 7. Log Success				-- MySQL procedures don't print to console easily. 				-- We usually return a result set to confirm success.				SELECT v_new_order_id AS OrderID, v_total_amount AS TotalAmount, 'Order Placed Successfully' AS Message;						END		-- Trigger	CREATE DEFINER=`dbsysgr1`@`%` TRIGGER trg_reduce_stock	AFTER INSERT ON Order_Item	FOR EACH ROW	BEGIN		-- 1. Decrease the stock for the ordered meal		UPDATE Meal 		SET stock_quantity = stock_quantity - NEW.quantity		WHERE meal_id = NEW.meal_id;		-- 2. If stock drops to 0 (or less), automatically mark as Sold Out		UPDATE Meal		SET is_available = 0		WHERE meal_id = NEW.meal_id AND stock_quantity <= 0;	END;