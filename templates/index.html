<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>University Canteen</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .header { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; gap: 20px; align-items: center; margin-bottom: 20px;}
        .control-group { display: flex; flex-direction: column; }
        
        /* Menu Grid */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        /* Card Styles */
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); }
        .card-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-bottom: 10px; font-weight: bold;}
        .badge-lunch { background-color: #e3f2fd; color: #1565c0; }
        .badge-vegan { background-color: #e8f5e9; color: #2e7d32; }
        .badge-normal { background-color: #fff3e0; color: #ef6c00; }
        
        .price { font-size: 1.4em; color: #333; font-weight: bold; margin-top: auto; padding-top: 15px;}
        .btn-order { background-color: #007bff; color: white; border: none; padding: 12px; width: 100%; cursor: pointer; font-size: 1em; text-align: center;}
        .btn-order:hover { background-color: #0056b3; }

        /* Notification */
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="header">
        <div class="control-group">
            <label><strong>Who is ordering?</strong></label>
            <select id="userSelect">
                <option>Loading users...</option>
            </select>
        </div>
        <div class="control-group">
            <label><strong>Pickup Time:</strong></label>
            <input type="time" id="pickupTime">
        </div>
    </div>

    <div id="menu-container" class="menu-grid">
        Loading Menu...
    </div>

    <div id="toast"></div>

    <script>
        // 1. Initialize Page
        const today = new Date();
        // Default time to 1 hour from now
        today.setHours(today.getHours() + 1);
        const timeString = today.toTimeString().split(' ')[0].substring(0,5);
        document.getElementById('pickupTime').value = timeString;

        // 2. Fetch Users for Dropdown
        async function loadUsers() {
            const res = await fetch('/api/users');
            const users = await res.json();
            const select = document.getElementById('userSelect');
            select.innerHTML = '';
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.text = `${u.name} (${u.role})`;
                select.appendChild(opt);
            });
        }

        // 3. Fetch Menu for Grid
        async function loadMenu() {
            const res = await fetch('/api/menu');
            const menu = await res.json();
            const container = document.getElementById('menu-container');
            container.innerHTML = '';

            menu.forEach(item => {
                const badgeClass = item.type === 'Vegan' ? 'badge-vegan' : 'badge-normal';
                
                const card = `
                    <div class="card">
                        <div class="card-body">
                            <div>
                                <span class="badge badge-lunch">${item.category}</span>
                                <span class="badge ${badgeClass}">${item.type}</span>
                            </div>
                            <h3>${item.name}</h3>
                            <p style="color:#666">${item.description || "No description available."}</p>
                            <div class="price">$${item.price}</div>
                        </div>
                        <button class="btn-order" onclick="placeOrder(${item.meal_id}, '${item.name}')">
                            Order Now
                        </button>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // 4. Handle Ordering
        async function placeOrder(mealId, mealName) {
            // 1. GET VALUES
            const userSelect = document.getElementById('userSelect');
            const userIdStr = userSelect.value;
            const userId = parseInt(userIdStr); // Converts string to Integer
            
            const timeVal = document.getElementById('pickupTime').value; 
            const sqlTime = `${timeVal}:00`; 

            // 2. DEBUGGING: Check validation BEFORE sending
            console.log("--- DEBUGGING ORDER ---");
            console.log("Raw User String:", userIdStr);
            console.log("Converted User ID:", userId);
            console.log("Meal ID:", mealId);
            
            // STOP if User ID is invalid (This prevents the 422 Error)
            if (isNaN(userId)) {
                alert("❌ Error: No User Selected! Please wait for the user list to load.");
                return; // Stop here
            }

            const toast = document.getElementById("toast");
            toast.innerText = "Processing...";
            toast.className = "show";

            try {
                // 3. SEND REQUEST
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,       
                        meal_id: parseInt(mealId), 
                        quantity: 1, 
                        pickup_time: sqlTime   
                    })
                });

                const result = await response.json();

                // 4. HANDLE RESPONSE
                if (response.ok) {
                    toast.innerText = `✅ Success! Ordered ${mealName}`;
                    toast.style.backgroundColor = "#2e7d32";
                } else {
                    console.error("Server Error Payload:", result);
                    // Show the specific validation error if it's a 422
                    if(result.detail && Array.isArray(result.detail)){
                        const missingField = result.detail[0].loc[1]; 
                        toast.innerText = `❌ Invalid Data: ${missingField}`;
                    } else {
                        toast.innerText = `❌ Error: ${result.detail || "Failed"}`;
                    }
                    toast.style.backgroundColor = "#c62828";
                }
            } catch (err) {
                console.error("Network Error:", err);
                toast.innerText = "❌ Network Error";
            }

            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        loadUsers();
        loadMenu();
    </script>
</body>
</html>